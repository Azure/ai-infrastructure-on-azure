name: Deploy Azure CycleCloud Workspace for Slurm (Reusable)

on:
  workflow_call:
    inputs:
      location:
        description: "Azure region (e.g., westus3, westeurope, westus2)"
        required: false
        type: string
        default: "westus3"
      htc_sku:
        description: "HTC partition VM SKU (e.g., Standard_F2s_v2)"
        required: false
        type: string
        default: "Standard_F2s_v2"
      hpc_sku:
        description: "HPC partition VM SKU (e.g., Standard_HB176rs_v4)"
        required: false
        type: string
        default: "Standard_HB176rs_v4"
      gpu_sku:
        description: "GPU partition VM SKU (e.g., Standard_ND96amsr_A100_v4)"
        required: false
        type: string
        default: "Standard_ND96amsr_A100_v4"
      scheduler_sku:
        description: "Scheduler node VM SKU"
        required: false
        default: "Standard_D4as_v5"
        type: string
      login_sku:
        description: "Login node VM SKU"
        required: false
        default: "Standard_D2as_v5"
        type: string
      workspace_ref:
        description: "Git ref (branch/tag) to checkout"
        required: false
        default: "2025.12.01"
        type: string
      htc_max_nodes:
        description: "Maximum nodes for HTC partition"
        required: false
        default: "100"
        type: string
      hpc_max_nodes:
        description: "Maximum nodes for HPC partition"
        required: false
        default: "16"
        type: string
      gpu_max_nodes:
        description: "Maximum nodes for GPU partition"
        required: false
        default: "8"
        type: string
      data_filesystem:
        description: "Enable Azure Managed Lustre data filesystem"
        required: false
        default: false
        type: boolean
      deploy_immediately:
        description: "Deploy immediately after generating parameters"
        required: false
        default: false
        type: boolean

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: testing

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Validate required secrets
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.SSH_PUBLIC_KEY }}" ]; then
            echo "::error::SSH_PUBLIC_KEY secret is required"
            exit 1
          fi
          if [ -z "${{ secrets.ADMIN_PASSWORD }}" ]; then
            echo "::error::ADMIN_PASSWORD secret is required"
            exit 1
          fi

      - name: Generate resource group name
        id: rg_name
        run: |
          set -euo pipefail
          # Generate resource group name with pattern ccw_YYDDMMHHmm
          timestamp=$(date -u +"%y%d%m%H%M")
          rg_name="ccw_${timestamp}"
          echo "resource_group=${rg_name}" >> "$GITHUB_OUTPUT"
          echo "Generated resource group name: ${rg_name}"

      - name: Accept Azure Marketplace terms
        if: inputs.deploy_immediately
        run: |
          set -euo pipefail
          echo "Deployment enabled - accepting Azure CycleCloud marketplace terms..."
          az vm image terms accept --publisher azurecyclecloud --offer azure-cyclecloud --plan cyclecloud8-gen2 || {
            echo "Failed to accept marketplace terms, but continuing..."
          }

      - name: Create SSH public key file
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 644 ~/.ssh/id_rsa.pub

      - name: Set script permissions
        run: |
          set -euo pipefail
          chmod +x infrastructure_references/azure_cyclecloud_workspace_for_slurm/scripts/deploy-ccws.sh

      - name: Build deployment command
        id: build_command
        env:
          SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          RG_NAME: ${{ steps.rg_name.outputs.resource_group }}
          LOCATION: ${{ inputs.location }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          HTC_SKU: ${{ inputs.htc_sku }}
          HPC_SKU: ${{ inputs.hpc_sku }}
          GPU_SKU: ${{ inputs.gpu_sku }}
          SCHEDULER_SKU: ${{ inputs.scheduler_sku }}
          LOGIN_SKU: ${{ inputs.login_sku }}
          WORKSPACE_REF: ${{ inputs.workspace_ref }}
          HTC_MAX: ${{ inputs.htc_max_nodes }}
          HPC_MAX: ${{ inputs.hpc_max_nodes }}
          GPU_MAX: ${{ inputs.gpu_max_nodes }}
          DATA_FILESYSTEM: ${{ inputs.data_filesystem }}
          DEPLOY_IMMEDIATELY: ${{ inputs.deploy_immediately }}
        run: |
          set -euo pipefail

          script="./infrastructure_references/azure_cyclecloud_workspace_for_slurm/scripts/deploy-ccws.sh"
          # Build command as an array to avoid quoting issues and eval
          cmd=(
            "$script"
            --subscription-id "$SUBSCRIPTION_ID"
            --resource-group "$RG_NAME"
            --location "$LOCATION"
            --ssh-public-key-file "$HOME/.ssh/id_rsa.pub"
            --admin-password "$ADMIN_PASSWORD"
            --htc-sku "$HTC_SKU"
            --hpc-sku "$HPC_SKU"
            --gpu-sku "$GPU_SKU"
            --admin-username "hpcadmin"
            --scheduler-sku "$SCHEDULER_SKU"
            --login-sku "$LOGIN_SKU"
            --workspace-ref "$WORKSPACE_REF"
            --htc-max-nodes "$HTC_MAX"
            --hpc-max-nodes "$HPC_MAX"
            --gpu-max-nodes "$GPU_MAX"
            --bastion --accept-marketplace --no-az --silent
          )

          if [ "${DATA_FILESYSTEM}" = "true" ]; then
            cmd+=(--data-filesystem)
          fi

          if [ "${DEPLOY_IMMEDIATELY}" = "true" ]; then
            cmd+=(--deploy)
          fi

          # Emit the command as a single line to outputs for visibility/logging
          printf 'command=%q ' "${cmd[@]}" >> "$GITHUB_OUTPUT"
          echo >> "$GITHUB_OUTPUT" # newline

      - name: Run deploy-ccws.sh script
        run: |
          set -euo pipefail
          cd "${{ github.workspace }}"
          echo "Executing deployment command..."
          # Rebuild command from outputs or just reconstruct directly (safer to run array again)
          script="./infrastructure_references/azure_cyclecloud_workspace_for_slurm/scripts/deploy-ccws.sh"
          args=(
            --subscription-id "${{ secrets.AZURE_SUBSCRIPTION_ID }}"
            --resource-group "${{ steps.rg_name.outputs.resource_group }}"
            --location "${{ inputs.location }}"
            --ssh-public-key-file "$HOME/.ssh/id_rsa.pub"
            --admin-password "${{ secrets.ADMIN_PASSWORD }}"
            --htc-sku "${{ inputs.htc_sku }}"
            --hpc-sku "${{ inputs.hpc_sku }}"
            --gpu-sku "${{ inputs.gpu_sku }}"
            --admin-username "hpcadmin"
            --scheduler-sku "${{ inputs.scheduler_sku }}"
            --login-sku "${{ inputs.login_sku }}"
            --workspace-ref "${{ inputs.workspace_ref }}"
            --htc-max-nodes "${{ inputs.htc_max_nodes }}"
            --hpc-max-nodes "${{ inputs.hpc_max_nodes }}"
            --gpu-max-nodes "${{ inputs.gpu_max_nodes }}"
            --bastion --accept-marketplace --no-az --silent
          )
          if [ "${{ inputs.data_filesystem }}" = "true" ]; then
            args+=(--data-filesystem)
          fi
          if [ "${{ inputs.deploy_immediately }}" = "true" ]; then
            args+=(--deploy)
          fi
          # Execute
          "$script" "${args[@]}"

      - name: Wait for login VMSS and validate instances
        if: inputs.deploy_immediately
        timeout-minutes: 20
        run: |
          set -euo pipefail

          RG_NAME="${{ steps.rg_name.outputs.resource_group }}"
          VMSS_PATTERN="login-"
          TIMEOUT_MINUTES=20
          CHECK_INTERVAL=30  # Check every 30 seconds
          MAX_ATTEMPTS=$((TIMEOUT_MINUTES * 60 / CHECK_INTERVAL))

          echo "ðŸ” Waiting for VMSS with pattern '${VMSS_PATTERN}*' in resource group '${RG_NAME}'..."
          echo "â±ï¸ Timeout: ${TIMEOUT_MINUTES} minutes (${MAX_ATTEMPTS} attempts with ${CHECK_INTERVAL}s intervals)"

          VMSS_FOUND=false
          INSTANCES_RUNNING=false

          for attempt in $(seq 1 "$MAX_ATTEMPTS"); do
            echo "ðŸ”„ Attempt ${attempt}/${MAX_ATTEMPTS}: Checking for VMSS..."
            
            # Find VMSS with login- pattern
            VMSS_LIST=$(az vmss list --resource-group "$RG_NAME" \
              --query "[?starts_with(name, '${VMSS_PATTERN}')].name" \
              --output tsv 2>/dev/null || echo "")
            
            if [ -n "$VMSS_LIST" ]; then
              VMSS_NAME=$(echo "$VMSS_LIST" | head -n 1)
              echo "âœ… Found VMSS: ${VMSS_NAME}"
              VMSS_FOUND=true
              
              # Check for running instances
              echo "ðŸ” Checking instances in VMSS '${VMSS_NAME}'..."
              RUNNING_INSTANCES=$(az vmss list-instances --resource-group "$RG_NAME" --name "$VMSS_NAME" \
                --query "[?provisioningState=='Succeeded'].instanceId" \
                --output tsv 2>/dev/null || echo "")
              
              if [ -n "$RUNNING_INSTANCES" ]; then
                INSTANCE_COUNT=$(echo "$RUNNING_INSTANCES" | wc -l)
                echo "âœ… Found ${INSTANCE_COUNT} running instance(s) in VMSS '${VMSS_NAME}'"
                INSTANCES_RUNNING=true
                break
              else
                echo "âš ï¸ VMSS '${VMSS_NAME}' found but no instances are running yet"
              fi
            else
              echo "â³ No VMSS with pattern '${VMSS_PATTERN}*' found yet"
            fi
            
            if [ "$attempt" -lt "$MAX_ATTEMPTS" ]; then
              echo "ðŸ’¤ Waiting ${CHECK_INTERVAL} seconds before next check..."
              sleep "$CHECK_INTERVAL"
            fi
          done

          # Final validation
          if [ "$VMSS_FOUND" = false ]; then
            echo "âŒ FAILURE: No VMSS with pattern '${VMSS_PATTERN}*' found after ${TIMEOUT_MINUTES} minutes"
            echo "::error::VMSS validation failed: No VMSS found with pattern '${VMSS_PATTERN}*'"
            exit 1
          elif [ "$INSTANCES_RUNNING" = false ]; then
            echo "âŒ FAILURE: VMSS found but no running instances after ${TIMEOUT_MINUTES} minutes"
            echo "::error::VMSS validation failed: No running instances found in VMSS"
            exit 1
          else
            echo "ðŸŽ‰ SUCCESS: VMSS '${VMSS_NAME}' found with running instances"
            echo "::notice::VMSS validation successful: Found '${VMSS_NAME}' with running instances"
          fi

      - name: Check CycleCloud VM cloud-init logs
        if: failure() && inputs.deploy_immediately
        run: |
          set -euo pipefail
          RG_NAME="${{ steps.rg_name.outputs.resource_group }}"
        
          echo "ðŸ” Checking cloud-init logs on CycleCloud VM"
          az vm run-command invoke \
            --resource-group "$RG_NAME" \
            --name "ccw-cyclecloud-vm" \
            --command-id RunShellScript \
            --scripts "tail -n 200 /var/log/cloud-init-output.log" \
            --query "value[0].message" \
            --output tsv

      - name: Display deployment summary
        if: success()
        run: |
          set -euo pipefail
          {
            echo "## Deployment Summary"
            echo "- **Workspace Reference**: ${{ inputs.workspace_ref }}"
            echo "- **Resource Group**: ${{ steps.rg_name.outputs.resource_group }}"
            echo "- **Location**: ${{ inputs.location }}"
            echo "- **Data Filesystem (Lustre)**: ${{ inputs.data_filesystem }}"
            echo "- **Deploy Immediately**: ${{ inputs.deploy_immediately }}"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ -f "infrastructure_references/azure_cyclecloud_workspace_for_slurm/scripts/output.json" ]; then
            echo "âœ… Parameters file generated successfully" >> "$GITHUB_STEP_SUMMARY"
            echo "=================================="
            jq -c . infrastructure_references/azure_cyclecloud_workspace_for_slurm/scripts/output.json >> "$GITHUB_STEP_SUMMARY"
            echo "=================================="
          fi

      - name: List resources before cleanup
        if: always() && inputs.deploy_immediately
        run: |
          set -euo pipefail
          RG_NAME="${{ steps.rg_name.outputs.resource_group }}"
          echo "ðŸ“‹ Listing all resources in resource group: ${RG_NAME}"

          if az group exists --name "$RG_NAME" --output tsv 2>/dev/null | grep -q "true"; then
            echo "Resource group exists, listing resources..."
            RESOURCES=$(az resource list --resource-group "$RG_NAME" --query "[].{Name:name, Type:type}" --output table 2>/dev/null || echo "")
            
            if [ -n "$RESOURCES" ]; then
              {
                echo "## Resources in Resource Group '${RG_NAME}'"
                echo '```'
                echo "$RESOURCES"
                echo '```'
              } >> "$GITHUB_STEP_SUMMARY"
              echo "Found resources:"
              echo "$RESOURCES"
            else
              echo "No resources found in resource group"
              echo "â„¹ï¸ No resources found in resource group '${RG_NAME}'" >> "$GITHUB_STEP_SUMMARY"
            fi
          else
            echo "Resource group '${RG_NAME}' does not exist"
            echo "â„¹ï¸ Resource group '${RG_NAME}' does not exist" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Cleanup resource group after deployment
        if: always() && inputs.deploy_immediately
        run: |
          set -euo pipefail
          echo "Cleaning up resource group: ${{ steps.rg_name.outputs.resource_group }}"
          if az group exists --name "${{ steps.rg_name.outputs.resource_group }}" --output tsv 2>/dev/null | grep -q "true"; then
            echo "Resource group exists, deleting..."
            az group delete --name "${{ steps.rg_name.outputs.resource_group }}" --yes --no-wait
            echo "âœ… Resource group deletion initiated" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Resource group does not exist, nothing to clean up"
          fi
