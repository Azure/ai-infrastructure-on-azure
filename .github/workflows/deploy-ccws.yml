name: Deploy Azure CycleCloud Workspace for Slurm (CCWS)

on:
  push:
    paths:
      - ".github/workflows/deploy-ccws.yml"
      - ".github/workflows/deploy-ccws-callable.yml"
      - "infrastructure_references/azure_cyclecloud_workspace_for_slurm/scripts/deploy-ccws.sh"

  workflow_dispatch:
    inputs:
      location:
        description: "Azure region (e.g., westus3, westeurope, westus2)"
        required: true
        type: string
        default: "westus3"
      deploy_immediately:
        description: "Deploy immediately after generating parameters"
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      location: ${{ steps.params.outputs.location }}
      deploy_immediately: ${{ steps.params.outputs.deploy_immediately }}

    steps:
      - name: Set deployment parameters
        id: params
        env:
          EVENT_NAME: ${{ github.event_name }}
          LOCATION_IN: ${{ inputs.location }}
          DEPLOY_IMMEDIATELY_IN: ${{ inputs.deploy_immediately }}
        run: |
          set -euo pipefail

          if [ "${EVENT_NAME}" = "push" ]; then
            # Push defaults (different HPC/GPU defaults per your original intent)
            {
              echo "location=westus3"
              echo "deploy_immediately=false"
            } >> "$GITHUB_OUTPUT"
          else
            # Inputs with shell defaults
            location="${LOCATION_IN:-westus3}"
            # Note: GitHub passes booleans as strings; default to "false"
            deploy_immediately="${DEPLOY_IMMEDIATELY_IN:-false}"

            {
              echo "location=${location}"
              echo "deploy_immediately=${deploy_immediately}"
            } >> "$GITHUB_OUTPUT"
          fi

  call-deployment:
    needs: init
    uses: ./.github/workflows/deploy-ccws-callable.yml
    with:
      location: ${{ needs.init.outputs.location }}
      deploy_immediately: ${{ needs.init.outputs.deploy_immediately }}
    secrets: inherit
