name: Deploy Azure CycleCloud Workspace for Slurm (CCWS)

on:
  push:
    paths:
      - '.github/workflows/deploy-ccws.yml'
      - '.github/workflows/deploy-ccws-callable.yml'
      - 'infrastructure_references/azure_cyclecloud_workspace_for_slurm/scripts/deploy-ccws.sh'

  workflow_dispatch:
    inputs:
      location:
        description: 'Azure region (e.g., westus3, westeurope, westus2)'
        required: true
        type: string
        default: 'westus3'
      htc_sku:
        description: 'HTC partition VM SKU (e.g., Standard_F2s_v2)'
        required: true
        type: string
        default: 'Standard_F2s_v2'
      hpc_sku:
        description: 'HPC partition VM SKU (e.g., Standard_HB176rs_v4)'
        required: true
        type: string
        default: 'Standard_HB176rs_v4'
      gpu_sku:
        description: 'GPU partition VM SKU (e.g., Standard_ND96amsr_A100_v4)'
        required: true
        type: string
        default: 'Standard_ND96amsr_A100_v4'
      htc_max_nodes:
        description: 'Maximum nodes for HTC partition'
        required: false
        default: '100'
        type: string
      hpc_max_nodes:
        description: 'Maximum nodes for HPC partition'
        required: false
        default: '16'
        type: string
      gpu_max_nodes:
        description: 'Maximum nodes for GPU partition'
        required: false
        default: '8'
        type: string
      deploy_immediately:
        description: 'Deploy immediately after generating parameters'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  init:
    runs-on: ubuntu-latest
    outputs:
      location: ${{ steps.params.outputs.location }}
      htc_sku: ${{ steps.params.outputs.htc_sku }}
      hpc_sku: ${{ steps.params.outputs.hpc_sku }}
      gpu_sku: ${{ steps.params.outputs.gpu_sku }}
      htc_max_nodes: ${{ steps.params.outputs.htc_max_nodes }}
      hpc_max_nodes: ${{ steps.params.outputs.hpc_max_nodes }}
      gpu_max_nodes: ${{ steps.params.outputs.gpu_max_nodes }}
      deploy_immediately: ${{ steps.params.outputs.deploy_immediately }}
    steps:
    - name: Set deployment parameters
      id: params
      run: |
        # Set default values based on trigger type
        if [ "${{ github.event_name }}" = "push" ]; then
          {
            echo "location=westus3"
            echo "htc_sku=Standard_F2s_v2"
            echo "hpc_sku=Standard_HB176rs_v4"
            echo "gpu_sku=Standard_ND96amsr_A100_v4"
            echo "htc_max_nodes=100"
            echo "hpc_max_nodes=50"
            echo "gpu_max_nodes=20"
            echo "deploy_immediately='false'"
          } >> "$GITHUB_OUTPUT"
        else
          {
            echo "location=${{ inputs.location || 'westus3' }}"
            echo "htc_sku=${{ inputs.htc_sku || 'Standard_F2s_v2' }}"
            echo "hpc_sku=${{ inputs.hpc_sku || 'Standard_HB176rs_v4' }}"
            echo "gpu_sku=${{ inputs.gpu_sku || 'Standard_ND96amsr_A100_v4' }}"
            echo "htc_max_nodes=${{ inputs.htc_max_nodes || '100' }}"
            echo "hpc_max_nodes=${{ inputs.hpc_max_nodes || '16' }}"
            echo "gpu_max_nodes=${{ inputs.gpu_max_nodes || '8' }}" >>
            echo "deploy_immediately=${{ inputs.deploy_immediately || 'false' }}"
          } >> "$GITHUB_OUTPUT"
        fi

  call-deployment:
    needs: init
    uses: ./.github/workflows/deploy-ccws-callable.yml
    with:
      location: ${{ needs.init.outputs.location }}
      htc_sku: ${{ needs.init.outputs.htc_sku }}
      hpc_sku: ${{ needs.init.outputs.hpc_sku }}
      gpu_sku: ${{ needs.init.outputs.gpu_sku }}
      workspace_ref: ${{ needs.init.outputs.workspace_ref }}
      htc_max_nodes: ${{ needs.init.outputs.htc_max_nodes }}
      hpc_max_nodes: ${{ needs.init.outputs.hpc_max_nodes }}
      gpu_max_nodes: ${{ needs.init.outputs.gpu_max_nodes }}
      deploy_immediately: ${{ needs.init.outputs.deploy_immediately }}
    secrets: inherit