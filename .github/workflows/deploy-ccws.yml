name: Deploy Azure CycleCloud Workspace for Slurm (CCWS)

on:
  push:
    branches:
      - xpillons/103    

  workflow_dispatch:
    inputs:
      location:
        description: 'Azure region (e.g., westus3, westeurope, westus2)'
        required: true
        type: string
        default: 'westus3'
      htc_sku:
        description: 'HTC partition VM SKU (e.g., Standard_F2s_v2)'
        required: true
        type: string
        default: 'Standard_F2s_v2'
      hpc_sku:
        description: 'HPC partition VM SKU (e.g., Standard_HB176rs_v4)'
        required: true
        type: string
        default: 'Standard_HB176rs_v4'
      gpu_sku:
        description: 'GPU partition VM SKU (e.g., Standard_ND96amsr_A100_v4)'
        required: true
        type: string
        default: 'Standard_ND96amsr_A100_v4'
      scheduler_sku:
        description: 'Scheduler node VM SKU'
        required: false
        default: 'Standard_D4as_v5'
        type: string
      login_sku:
        description: 'Login node VM SKU'
        required: false
        default: 'Standard_D2as_v5'
        type: string
      workspace_ref:
        description: 'Git ref (branch/tag) to checkout'
        required: false
        default: '2025.12.01'
        type: string
      htc_max_nodes:
        description: 'Maximum nodes for HTC partition'
        required: false
        default: '100'
        type: string
      hpc_max_nodes:
        description: 'Maximum nodes for HPC partition'
        required: false
        default: '16'
        type: string
      gpu_max_nodes:
        description: 'Maximum nodes for GPU partition'
        required: false
        default: '8'
        type: string
      deploy_immediately:
        description: 'Deploy immediately after generating parameters'
        required: false
        default: false
        type: boolean

permissions:
    id-token: write
    contents: read
        
jobs:
  deploy:
    uses: ./.github/workflows/deploy-ccws-callable.yml
    with:
      location: ${{ inputs.location }}
      htc_sku: ${{ inputs.htc_sku }}
      hpc_sku: ${{ inputs.hpc_sku }}
      gpu_sku: ${{ inputs.gpu_sku }}
      scheduler_sku: ${{ inputs.scheduler_sku }}
      login_sku: ${{ inputs.login_sku }}
      workspace_ref: ${{ inputs.workspace_ref }}
      htc_max_nodes: ${{ inputs.htc_max_nodes }}
      hpc_max_nodes: ${{ inputs.hpc_max_nodes }}
      gpu_max_nodes: ${{ inputs.gpu_max_nodes }}
      deploy_immediately: ${{ inputs.deploy_immediately }}
    secrets: inherit